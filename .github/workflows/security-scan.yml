name: Security Scan

on:
  push:
    branches: [ master, production ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 python3-pip
      
      - name: Install dependencies
        run: |
          echo "Installing backend dependencies..."
          cd backend
          npm ci --legacy-peer-deps
          
          echo "Installing frontend dependencies..."
          cd ../frontend
          npm ci --legacy-peer-deps
      
      - name: Run Security Audit
        run: |
          echo "ðŸ” Running security audit on backend..."
          cd backend
          npm audit --audit-level=moderate || true
          
          echo "ðŸ” Running security audit on frontend..."
          cd ../frontend
          npm audit --audit-level=moderate || true
          
          echo "âœ… Security audit completed"
      
      - name: Check for known vulnerabilities
        run: |
          echo "ðŸ” Checking for known vulnerabilities..."
          
          # Backend vulnerability check
          cd backend
          if npm audit --audit-level=high --json | jq -e '.vulnerabilities | length > 0' > /dev/null 2>&1; then
            echo "âš ï¸ High-severity vulnerabilities found in backend"
            npm audit --audit-level=high
          else
            echo "âœ… No high-severity vulnerabilities in backend"
          fi
          
          # Frontend vulnerability check
          cd ../frontend
          if npm audit --audit-level=high --json | jq -e '.vulnerabilities | length > 0' > /dev/null 2>&1; then
            echo "âš ï¸ High-severity vulnerabilities found in frontend"
            npm audit --audit-level=high
          else
            echo "âœ… No high-severity vulnerabilities in frontend"
          fi
      
      - name: Generate Security Report
        run: |
          echo "ðŸ“Š Generating security report..."
          
          echo "## Security Scan Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          
          echo "### Backend Dependencies" >> security-report.md
          cd backend
          npm audit --audit-level=moderate --json > ../backend-audit.json || true
          echo "Backend audit completed" >> ../security-report.md
          
          echo "### Frontend Dependencies" >> security-report.md
          cd ../frontend
          npm audit --audit-level=moderate --json > ../frontend-audit.json || true
          echo "Frontend audit completed" >> ../security-report.md
          
          echo "âœ… Security report generated"
      
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: |
            security-report.md
            backend-audit.json
            frontend-audit.json